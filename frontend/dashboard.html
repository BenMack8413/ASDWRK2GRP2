<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dashboard</title>

        <link rel="stylesheet" href="./css/style.css" />
    </head>
    <body>
        <div class="dashboard">
            <!--LEFT SIDE BAR STARTS HERE-->
            <aside class="sidebar">
                <div class="budget_name">My Budget</div>
                <div>
                    <div class="balance">Menu</div>
                </div>
                <nav class="nav">
                    <a class="active" onclick="location.href='/dashboard.html';">Dashboard</a>
                    <a onclick="location.href='/budget.html';">Budget</a>
                    <a onclick="location.href='/income.html';">Income</a>
                    <a onclick="location.href='/expenses.html';">Expenses</a>
                    <a onclick="location.href='/chart.html';">Charts</a>
                    <a onclick="location.href='/categories.html';">Categories</a>
                    <a onclick="location.href='/saving-goals.html';">Saving Goals</a>
                    <a onclick="location.href='/upcoming-payments.html';">Upcoming Payments</a>
                    <a onclick="location.href='/account.html';">Settings</a>
                </nav>
            </aside>
            <!--LEFT SIDE BAR END HERE-->

            <!-- Main starts here -->
            <main class="main">
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    "
                >
                    <h1>Dashboard</h1>
                </div>
                <div class="top_row">
                    <div class="card small">
                        <div class="widget_header">
                            <div><h3>Current Balance</h3></div>
                            <div class="balance_amount" id="currentBalance">$0</div>
                        </div>
                    </div>
                    <div class="card medium">
                        <h3 style="margin-bottom: 8px">Latest transactions</h3>
                        <div
                            id="miniTx"
                            style="
                                display: flex;
                                flex-direction: column;
                                gap: 8px;
                            "
                        >
                            <!-- small tx preview -->
                        </div>
                    </div>
                    <div class="card medium">
                        <div class="widget_header">
                            <div>
                                <h3>Income</h3>
                                <div class="muted">Monthly trend</div>
                            </div>
                        </div>
                        <div class="chart-wrap" style="margin-top: 12px">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>

                    <div class="card half">
                        <h3>Payment history</h3>
                        <div class="transactions" id="recentTx">
                            <!-- recent transactions here-->
                        </div>
                    </div>
                </div>

                <div class="widgets">
                    <div
                        class="widget"
                        draggable="true"
                        data-id="widget-pie"
                        id="widget-pie"
                    >
                        <div class="widget-header">
                            <div>
                                <h3>Spending by category</h3>
                                <div class="muted">This month</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; height: 220px">
                            <canvas id="spendPie"></canvas>
                        </div>
                    </div>

                    <div
                        class="widget"
                        draggable="true"
                        data-id="widget-activity"
                        id="widget-activity"
                    >
                        <div class="widget-header">
                            <div>
                                <h3>Activity</h3>
                                <div class="muted">Income vs Spending</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; height: 220px">
                            <canvas id="activityBar"></canvas>
                        </div>
                    </div>
                </div>
            </main>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                // --- CONFIG ---
                const INCOME_API = '/api/incomes';
                const BUDGET_ID = 1; // update if you use another budget id

                // keep a small sample object for non-income placeholders (expenses/categories)
                const sample = {
                    recentTx: [], // will be filled from API
                    monthly: {
                        months: [],
                        income: [],
                        expense: [6800, 6600, 5900, 6650, 6500, 6900, 6000],
                    },
                    categories: [
                        { label: 'Rent', value: 3300 },
                        { label: 'Food', value: 1000 },
                        { label: 'Transport', value: 300 },
                        { label: 'Shopping', value: 700 },
                        { label: 'Saving', value: 600 },
                        { label: 'Investments', value: 800 },
                        { label: 'Other', value: 200 },
                    ],
                };

                function safeCtx(id) {
                    const el = document.getElementById(id);
                    return el && el.getContext ? el.getContext('2d') : null;
                }

                function formatCurrency(amount) {
                    try {
                        return amount.toLocaleString(undefined, {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 2,
                        });
                    } catch (e) {
                        return '$' + Number(amount).toFixed(2);
                    }
                }

                function renderRecentTx() {
                    const container = document.getElementById('recentTx');
                    if (!container) return;
                    container.innerHTML = '';
                    sample.recentTx.forEach((tx) => {
                        const el = document.createElement('div');
                        el.className = 'tx';
                        const left = document.createElement('div');
                        left.className = 'meta';
                        const dot = document.createElement('div');
                        dot.className = 'dot';
                        dot.textContent = (tx.title || '•')[0] || '•';
                        left.appendChild(dot);
                        const txt = document.createElement('div');
                        txt.innerHTML = `<div style="font-weight:600">${tx.title}</div><div class="muted">${tx.date}</div>`;
                        left.appendChild(txt);
                        const amt = document.createElement('div');
                        amt.style.fontWeight = 700;
                        amt.textContent = (tx.amount > 0 ? '+' : '') + formatCurrency(tx.amount);
                        if (tx.amount < 0) amt.style.color = '#ff5c68';
                        else if (tx.amount > 0) amt.style.color = '#16a34a';
                        el.appendChild(left);
                        el.appendChild(amt);
                        container.appendChild(el);
                    });
                }

                function renderMiniTx() {
                    const mini = document.getElementById('miniTx');
                    if (!mini) return;
                    mini.innerHTML = '';
                    sample.recentTx.slice(0, 3).forEach((tx) => {
                        const row = document.createElement('div');
                        row.style.display = 'flex';
                        row.style.justifyContent = 'space-between';
                        row.style.alignItems = 'center';
                        row.style.padding = '6px 0';
                        const amountText = (tx.amount > 0 ? '+' : '') + formatCurrency(tx.amount);
                        row.innerHTML = `<div style="font-size:13px">${tx.title}</div><div style="font-weight:700">${amountText}</div>`;
                        mini.appendChild(row);
                    });
                }

                let incomeChart, spendPie, activityBar;
                function initCharts() {
                    const ctxIncome = safeCtx('incomeChart');
                    if (ctxIncome) {
                        const months = sample.monthly.months.length
                            ? sample.monthly.months
                            : getLastNMonthLabels(7).labels;

                        incomeChart = new Chart(ctxIncome, {
                            type: 'line',
                            data: {
                                labels: months.slice(-6),
                                datasets: [
                                    {
                                        label: 'Income',
                                        data: sample.monthly.income.slice(-6),
                                        fill: false,
                                        tension: 0.3,
                                        borderWidth: 2,
                                        pointBackgroundColor: '#fff',
                                        pointBorderColor: 'rgba(59,91,216,0.95)',
                                        tension: 0.4,
                                        fill: true,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true } },
                            },
                        });
                    }
                    const ctxPie = safeCtx('spendPie');
                    if (ctxPie) {
                        spendPie = new Chart(ctxPie, {
                            type: 'doughnut',
                            data: {
                                labels: sample.categories.map((c) => c.label),
                                datasets: [
                                    {
                                        data: sample.categories.map((c) => c.value),
                                        hoverOffset: 6,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'right' } },
                            },
                        });
                    }

                    const ctxBar = safeCtx('activityBar');
                    if (ctxBar) {
                        activityBar = new Chart(ctxBar, {
                            type: 'bar',
                            data: {
                                labels: getLastNMonthLabels(7).labels,
                                datasets: [
                                    {
                                        label: 'Income',
                                        data: sample.monthly.income.length
                                            ? sample.monthly.income
                                            : [7000, 7000, 7000, 7000, 7000, 7000, 7000],
                                        stack: 'a',
                                    },
                                    {
                                        label: 'Spending',
                                        data: sample.monthly.expense,
                                        stack: 'a',
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'top' } },
                                scales: { y: { beginAtZero: true } },
                            },
                        });
                    }
                }

                function getLastNMonthLabels(n) {
                    const labels = [];
                    const keys = []; // YYYY-MM keys
                    const now = new Date();
                    for (let i = n - 1; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        keys.push(key);
                        labels.push(d.toLocaleString(undefined, { month: 'short' }));
                    }
                    return { keys, labels };
                }

                // Fetch incomes from API and populate dashboard widgets
                async function loadIncomesForDashboard() {
                    try {
                        const res = await fetch(`${INCOME_API}?budget_id=${BUDGET_ID}`);
                        if (!res.ok) throw new Error('Failed to fetch incomes');
                        const incomes = await res.json();

                        // Build recentTx from incomes (most recent first)
                        const sorted = incomes.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

                        sample.recentTx = sorted.slice(0, 8).map((inc) => ({
                            id: inc.id,
                            title: inc.description || inc.source || 'Income',
                            date: new Date(inc.date).toLocaleDateString(),
                            amount: Number(inc.amount) || 0,
                        }));

                        // Calculate total income (sum of all incomes)
                        const totalIncome = incomes.reduce((s, x) => s + (Number(x.amount) || 0), 0);

                        // Prepare monthly totals for the last 7 months
                        const { keys, labels } = getLastNMonthLabels(7);
                        const monthMap = Object.fromEntries(keys.map((k) => [k, 0]));
                        incomes.forEach((inc) => {
                            if (!inc.date) return;
                            const d = new Date(inc.date);
                            if (isNaN(d)) return;
                            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            if (monthMap[key] != null) monthMap[key] += Number(inc.amount) || 0;
                        });

                        sample.monthly.months = labels;
                        sample.monthly.income = keys.map((k) => Math.round((monthMap[k] || 0) * 100) / 100);

                        // Update UI pieces
                        document.getElementById('currentBalance').textContent = formatCurrency(totalIncome);
                        renderRecentTx();
                        renderMiniTx();

                        // Update charts if they exist
                        if (incomeChart) {
                            incomeChart.data.labels = sample.monthly.months.slice(-6);
                            incomeChart.data.datasets[0].data = sample.monthly.income.slice(-6);
                            incomeChart.update();
                        }
                        if (activityBar) {
                            activityBar.data.labels = getLastNMonthLabels(7).labels;
                            activityBar.data.datasets[0].data = sample.monthly.income;
                            activityBar.update();
                        }
                    } catch (err) {
                        console.error('loadIncomesForDashboard error:', err);
                        // keep placeholders if API call fails
                    }
                }

                const LAYOUT_KEY = 'mb_dashboard_layout_v1';
                const HIDDEN_KEY = 'mb_dashboard_hidden_v1';

                function getHiddenWidgets() {
                    return [...document.querySelectorAll('.widget')]
                        .filter((w) => w.style.display === 'none')
                        .map((w) => w.id);
                }
                function saveHiddenState() {
                    try {
                        localStorage.setItem(HIDDEN_KEY, JSON.stringify(getHiddenWidgets()));
                    } catch (e) {}
                }

                function saveLayout() {
                    try {
                        const widgetsContainer = document.querySelector('.widgets');
                        if (!widgetsContainer) return;
                        const order = [...widgetsContainer.querySelectorAll('.widget')]
                            .map((w) => w.id)
                            .filter(Boolean);
                        localStorage.setItem(LAYOUT_KEY, JSON.stringify(order));
                        localStorage.setItem(HIDDEN_KEY, JSON.stringify(getHiddenWidgets()));
                        alert('Layout saved');
                    } catch (e) {}
                }

                function loadLayout() {
                    try {
                        const widgetsContainer = document.querySelector('.widgets');
                        if (!widgetsContainer) return;
                        const order = JSON.parse(localStorage.getItem(LAYOUT_KEY) || 'null');
                        if (order && Array.isArray(order)) {
                            order.forEach((id) => {
                                const el = document.getElementById(id);
                                if (el) widgetsContainer.appendChild(el);
                            });
                        }
                        const hidden = JSON.parse(localStorage.getItem(HIDDEN_KEY) || 'null');
                        if (hidden && Array.isArray(hidden)) {
                            document.querySelectorAll('.widget').forEach((w) => {
                                const visible = !hidden.includes(w.id);
                                w.style.display = visible ? 'block' : 'none';
                            });
                        }
                    } catch (e) {}
                }

                function resetLayout() {
                    try {
                        localStorage.removeItem(LAYOUT_KEY);
                        localStorage.removeItem(HIDDEN_KEY);
                        location.reload();
                    } catch (e) {}
                }

                (function init() {
                    // initialize charts with placeholder data first
                    initCharts();
                    // then load live incomes and refresh widgets/charts
                    loadIncomesForDashboard();
                    loadLayout();
                })();
            </script>
        </div>
    </body>
</html>

