<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login / Signup - Saniriser</title>
        <link rel="stylesheet" href="./css/style.css" />
        <style>
            .error {
                color: #e74c3c;
                font-size: 0.9em;
                margin-top: 4px;
            }

            input.error-field {
                border: 1px solid #e74c3c;
                outline: none;
            }

            body {
                margin: 0;
                font-family:
                    Inter,
                    ui-sans-serif,
                    system-ui,
                    -apple-system,
                    'Segoe UI',
                    Roboto,
                    'Helvetica Neue',
                    Arial;
                background: linear-gradient(135deg, #f3f6fb 0%, #e9edf5 100%);
                color: #111;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <div class="auth-container">
            <div class="auth-left">
                <h1>Saniriser</h1>
                <p>
                    Take control of your finances with our intuitive budget
                    tracking tool. Create budgets, track expenses, and achieve
                    your financial goals.
                </p>
            </div>
            <div class="auth-right">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="loginTab">
                        Log In
                    </button>
                    <button class="auth-tab" id="signupTab">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form class="auth-form active" id="loginForm">
                    <h2>Welcome Back</h2>
                    <div class="form-group">
                        <label for="login-username">Email</label>
                        <input
                            type="email"
                            id="login-username"
                            name="username"
                            class="form-input"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input
                            type="password"
                            id="login-password"
                            name="password"
                            class="form-input"
                            required
                        />
                    </div>
                    <div class="checkbox-group">
                        <input
                            type="checkbox"
                            id="login-remember"
                            name="remember"
                        />
                        <label for="login-remember">Remember me</label>
                    </div>
                    <button type="submit" class="submit-btn">Log In</button>
                    <div class="switch-form">
                        Don't have an account?
                        <a id="switchToSignup">Sign up</a>
                    </div>
                </form>

                <!-- Signup Form -->
                <form class="auth-form" id="signupForm">
                    <h2>Create Account</h2>
                    <div class="form-group">
                        <label for="signup-username">Username</label>
                        <input
                            type="text"
                            id="signup-username"
                            name="username"
                            class="form-input"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input
                            type="email"
                            id="signup-email"
                            name="email"
                            class="form-input"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input
                            type="password"
                            id="signup-password"
                            name="password"
                            class="form-input"
                            required
                        />
                    </div>
                    <div class="checkbox-group">
                        <input
                            type="checkbox"
                            id="signup-remember"
                            name="remember"
                        />
                        <label for="signup-remember">Remember me</label>
                    </div>
                    <button type="submit" class="submit-btn">Sign Up</button>
                    <div class="switch-form">
                        Already have an account?
                        <a id="switchToLogin">Log in</a>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Tab switching functionality
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const switchToSignup = document.getElementById('switchToSignup');
            const switchToLogin = document.getElementById('switchToLogin');

            function showLogin() {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
            }

            function showSignup() {
                signupTab.classList.add('active');
                loginTab.classList.remove('active');
                signupForm.classList.add('active');
                loginForm.classList.remove('active');
            }

            loginTab.addEventListener('click', showLogin);
            signupTab.addEventListener('click', showSignup);
            switchToLogin.addEventListener('click', showLogin);
            switchToSignup.addEventListener('click', showSignup);

            // Show correct tab based on button pressed on index.html
            const showTab = sessionStorage.getItem('showTab');
            if (showTab === 'signup') {
                showSignup();
            } else {
                showLogin();
            }
            sessionStorage.removeItem('showTab');

            // look for existing tokens
            window.addEventListener('DOMContentLoaded', async () => {
                const token = getToken();
                if (token) {
                    try {
                        const response = await fetch('/api/user/verify', {
                            method: 'GET',
                            headers: { authorization: `Bearer ${token}` },
                        });

                        if (response.ok) {
                            window.location.href = 'dashboard.html';
                        } else {
                            removeToken();
                        }
                    } catch (err) {
                        console.error('Token verification failed:', err);
                    }
                }
            });

            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email.trim());
            }

            function showError(input, message) {
                let errorEl = input.nextElementSibling;
                input.classList.add('error-field'); // add red border
                if (!errorEl || !errorEl.classList.contains('error')) {
                    errorEl = document.createElement('div');
                    errorEl.classList.add('error');
                    input.insertAdjacentElement('afterend', errorEl);
                }
                errorEl.textContent = message;
            }

            function clearError(input) {
                input.classList.remove('error-field');
                const errorEl = input.nextElementSibling;
                if (errorEl && errorEl.classList.contains('error')) {
                    errorEl.remove();
                }
            }

            // Signup form
            document
                .getElementById('signupForm')
                .addEventListener('submit', function (e) {
                    e.preventDefault();

                    const username = document
                        .getElementById('signup-username')
                        .value.trim();
                    const emailInput = document.getElementById('signup-email');
                    const email = emailInput.value.trim();
                    const password =
                        document.getElementById('signup-password').value;
                    const remember =
                        document.getElementById('signup-remember').checked;

                    clearError(emailInput);
                    if (!email) {
                        showError(emailInput, 'Email is required.');
                        return;
                    }
                    if (!isValidEmail(email)) {
                        showError(
                            emailInput,
                            'Please enter a valid email address.',
                        );
                        return;
                    }

                    signup(username, email, password, remember);
                });

            document
                .getElementById('loginForm')
                .addEventListener('submit', function (e) {
                    e.preventDefault();

                    const username = document
                        .getElementById('login-username')
                        .value.trim();
                    const password =
                        document.getElementById('login-password').value;
                    const remember =
                        document.getElementById('login-remember').checked;

                    if (!isValidEmail(username)) {
                        const loginInput =
                            document.getElementById('login-username');
                        clearError(loginInput);
                        showError(
                            loginInput,
                            'Please enter a valid email address.',
                        );
                        return;
                    }

                    login(username, password, remember);
                });
        </script>
        <script src="/scripts/token.js"></script>
    </body>
</html>
